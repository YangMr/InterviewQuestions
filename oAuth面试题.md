# oAuth2.0

## 1. 什么是oAuth2.0？

​		[OAuth 2.0](http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html) 是目前最流行的授权机制，用来授权第三方应用，获取用户数据。

​		**简单说，OAuth 就是一种授权机制。数据的所有者告诉系统，同意授权第三方应用进入系统，获取这些数据。系统从而产生一个短期的进入令牌（token），用来代替密码，供第三方应用使用**

## 2. 请描述令牌与密码的差异？

​		令牌（token）与密码（password）的作用是一样的，都可以进入系统，但是有三点差异。

​		（1）令牌是短期的，到期会自动失效，用户自己无法修改。密码一般长期有效，用户不修改，就不会发生变化。

​		（2）令牌可以被数据所有者撤销，会立即失效。以上例而言，屋主可以随时取消快递员的令牌。密码一般不允许被他人撤销。

​		（3）令牌有权限范围（scope），比如只能进小区的二号门。对于网络服务来说，只读令牌就比读写令牌更安全。密码一般是完整权限。

​		上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是 OAuth 2.0 的优点。

​		注意，只要知道了令牌，就能进入系统。系统一般不会再次确认身份，所以**令牌必须保密，泄漏令牌与泄漏密码的后果是一样的。** 这也是为什么令牌的有效期，一般都设置得很短的原因。

## 3. oAuth2.0 一共有几种授权机制？这几种授权机制分别是什么？

​		**OAuth 2.0 规定了四种获得令牌的流程。你可以选择最适合自己的那一种，向第三方应用颁发令牌。**下面就是这四种授权方式。

- 授权码（authorization-code）

- 隐藏式（implicit）

- 密码式（password）：

- 客户端凭证（client credentials）

  ​	注意，不管哪一种授权方式，第三方应用申请令牌之前，都必须先到系统备案，说明自己的身份，然后会拿到两个身份识别码：客户端 ID（client ID）和客户端密钥（client secret）。这是为了防止令牌被滥用，没有备案过的第三方应用，是不会拿到令牌的。

## 4. 请描述你对授权码模式的理解？

​		**授权码（authorization code）方式，指的是第三方应用先申请一个授权码，然后再用该码获取令牌。**

​		这种方式是最常用的流程，安全性也最高，它适用于那些有后端的 Web 应用。授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。

​		第一步，A 网站提供一个链接，用户点击后就会跳转到 B 网站，授权用户数据给 A 网站使用。下面就是 A 网站跳转 B 网站的一个示意链接。

```
https://b.com/oauth/authorize?
  response_type=code&
  client_id=CLIENT_ID&
  redirect_uri=CALLBACK_URL&
  scope=read
```

​		上面 URL 中，`response_type`参数表示要求返回授权码（`code`），`client_id`参数让 B 知道是谁在请求，`redirect_uri`参数是 B 接受或拒绝请求后的跳转网址，`scope`参数表示要求的授权范围（这里是只读）。

![img](https://www.wangbase.com/blogimg/asset/201904/bg2019040902.jpg)

​		第二步，用户跳转后，B 网站会要求用户登录，然后询问是否同意给予 A 网站授权。用户表示同意，这时 B 网站就会跳回`redirect_uri`参数指定的网址。跳转时，会传回一个授权码，就像下面这样。

```
https://a.com/callback?code=AUTHORIZATION_CODE
```

上面 URL 中，`code`参数就是授权码。

![img](https://www.wangbase.com/blogimg/asset/201904/bg2019040907.jpg)

第三步，A 网站拿到授权码以后，就可以在后端，向 B 网站请求令牌。

```
https://b.com/oauth/token?
 client_id=CLIENT_ID&
 client_secret=CLIENT_SECRET&
 grant_type=authorization_code&
 code=AUTHORIZATION_CODE&
 redirect_uri=CALLBACK_URL
```

上面 URL 中，`client_id`参数和`client_secret`参数用来让 B 确认 A 的身份（`client_secret`参数是保密的，因此只能在后端发请求），`grant_type`参数的值是`AUTHORIZATION_CODE`，表示采用的授权方式是授权码，`code`参数是上一步拿到的授权码，`redirect_uri`参数是令牌颁发后的回调网址

![img](https://www.wangbase.com/blogimg/asset/201904/bg2019040904.jpg)

第四步，B 网站收到请求以后，就会颁发令牌。具体做法是向`redirect_uri`指定的网址，发送一段 JSON 数据。

```
{    
  "access_token":"ACCESS_TOKEN",
  "token_type":"bearer",
  "expires_in":2592000,
  "refresh_token":"REFRESH_TOKEN",
  "scope":"read",
  "uid":100101,
  "info":{...}
}
```

上面 JSON 数据中，`access_token`字段就是令牌，A 网站在后端拿到了。

![img](https://www.wangbase.com/blogimg/asset/201904/bg2019040905.jpg)

## 5. 请描述第三方登录的原理？

```
A 网站让用户跳转到 GitHub。

GitHub 要求用户登录，然后询问"A 网站要求获得 xx 权限，你是否同意？"

用户同意，GitHub 就会重定向回 A 网站，同时发回一个授权码。

A 网站使用授权码，向 GitHub 请求令牌。

GitHub 返回令牌.

A 网站使用令牌，向 GitHub 请求用户数据。

```

## 6. 请描述用户名密码注册登陆流程？

​		这种方式在很多初期网站建设会使用，先注册，再进行登录，在老一点的cms中都能找到这个影子。

![img](https://user-gold-cdn.xitu.io/2019/6/19/16b6fb346d2dfe19)

流程说明：

> 1. 前端将用户名、密码发送到服务器，服务器进行常规的判断，判断用户名、密码长度是否满足，用户名是否重复等条件，条件不通过直接返回对应错误码给到前端，这里密码字段，为了防止传输过程中被截胡，建议加密再上传，我们的传输密码默认都是会进行一个md5加密，然后记录到数据库再进行一层加密，就算是脱库也没事，密码不要明文存储。
> 2. 校验通过后，就将用户名密码写入数据库，并进行后面积分发放等操作，这里不展开。
> 3. 现在进行登录，前端将用户名，密码发送给到服务端，服务端首先会校验登录次数是否超过设置的阈值，如果超过只能继续等待被关小黑屋。
> 4. 如果未超过继续登录逻辑，判断用户名、密码是否正确，不正确密码则进行阈值的判断，如果超过则关小黑屋，记住小黑屋必须设置过期时间，要不然就会永久关上了，这个可以用redis的过期来做。
> 5. 登录成功后进行后续的一切后置逻辑，比如加积分。。。等操作。

## 7. 请描述手机号注册登陆流程？

![img](https://user-gold-cdn.xitu.io/2019/6/19/16b6fb36d7bacb06)

流程说明：



> 1. 首先输入手机号，然后发送到服务端，服务端将手机号记录在我们数据库中，然后生成随机验证码，并将手机号和验证码绑定到一个redis里面，然后记录过期时间，这个过期时间一般是10分钟左右，这就是我们一般手机验证码的有效期。
> 2. 手机接收到手机短信后，那么就在界面填写验证码发送服务端，服务端收到验证码后就会在redis里面查询到这个手机号对应的验证码，失败就返回错误码。
> 3. 成功后就进行登录操作。

​		这里看起来没有明确的注册登录操作，其实在发送手机号码就可以认为是一个常规的注册，然后后面的验证码输入就是一个登陆操作，

**问：** 那我要密码咋办？

**答：** 在后续产品里面增加一个手机号码密码补录的功能即可，这也是现在很常规的手法，但是现在移动互联网大爆炸时代，密码已经显得不是那么重要了，反正我从来记不住密码，如果手机号码能操作的app，绝对不用密码来操作。

## 8. 请描述你做的项目都用到了哪些第三方登录？做的过程中有没有遇到一些坑？你是怎么解决的？

# 参考文献：

https://www.lizenghai.com/archives/32479.html

https://blog.csdn.net/belalds/article/details/80653432

https://coding.net/help/doc/account/3rd-party-account.html

https://www.jianshu.com/p/6cc69171b280